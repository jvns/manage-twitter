{% extends 'base.html' %}

{% block content %}

  <div id="app-4" class="col-md-4">
  <table class="table">
    <tr v-for="friend in friends">
    <td>
      <img :src="friend.profile_image_url_https"></td> <td>
      <a :href="'https://twitter.com/' + friend.screen_name">@${friend.screen_name}</a></td><td>
       ${ friend.statuses_count || 0 } tweets </td><td> 
       <span v-if="tweet_counts[friend.screen_name] !== null"> ${tweet_counts[friend.screen_name]} recent</span>
       <span class="retweets" v-if="no_retweets[friend.id] !== 1"> <a :href="'/update_friendship?retweets=false&screen_name=' + friend.screen_name">Turn off retweets </a></span>
      </td>
    </tr>
  </ul>
</div>
<a href="/logout">Logout</a>

<script type="text/javascript">
  var app4;
  var tl;
  Vue.config.delimiters = ['${', '}']

  function groupTimeline(timeline) {
      var counts = {}
      for (var i = 0; i < timeline.length; i++) {
          var tweet = timeline[i];
          var name = tweet.user.screen_name;
          if (counts[name] === undefined) {
              counts[name] = 0;
          }
          counts[name] += 1;
      }
      return counts;
  }

  function makeSet(ids) {
      var set = {};
      for (var i = 0; i < ids.length; i++) {
          set[ids[i]] = 1;
      }
      return set;
  }

  function displayFriends(friends, timeline, no_retweets) {
      var tweet_counts = groupTimeline(timeline);
      var no_retweets = makeSet(no_retweets);
      friends = friends.sort(function(a, b) {
          var c1 = tweet_counts[a.screen_name];
          var c2 = tweet_counts[b.screen_name];
          if (c1 == null) {
              return 1
          } else if (c2 == null) {
              return -1
          } else if (c1 > c2) {
              return -1;
          } else if (c1 < c2) {
              return 1;
          } else {
              return 0;
          }
      });
      app4 = new Vue({
          el: '#app-4',
          delimiters: ['${', '}'],
          data: {
              friends: friends,
              tweet_counts: tweet_counts,
              no_retweets: no_retweets,
          },
      });

  }

  function getOrCache(cacheId, url, callback) {
      var friends = JSON.parse(localStorage.getItem(cacheId));
      if (friends) {
          callback(friends);
      } else {
          $.get(url, function(resp) {
              friends = JSON.parse(resp);
              localStorage.setItem(cacheId, resp);
              callback(friends);
          })
      }
  }

  function main() {

      getOrCache("friends", "/users.json", function(friends) {
          getOrCache("home_timeline", "/home_timeline.json", function(timeline) {
              getOrCache("no_retweets", "/no_retweets.json", function(no_retweets) {
                  displayFriends(friends, timeline, no_retweets)
              })
          })
      })
  }
  $(document).ready(main)
</script>

{% endblock %}